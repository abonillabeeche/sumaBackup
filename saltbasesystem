Prepare SES nodes with Salt Stack

Admin:
zypper --non-interactive in salt-master
systemctl start salt-master.service

Clients:
zypper --non-interactive in salt-minion
set master in /etc/salt/minion
systemctl start salt-minion.service

Admin:
salt-key --accept-all

salt '*' pkg.install ntp yast2-ntp-client
#Configure yast ntp-client on the admin node
#or
#echo “server 130.57.1.4” >> /etc/ntp.conf
salt-cp '*' /etc/ntp.conf /etc/ntp.conf
salt '*' service.restart ntpd.service
salt '*' user.add ceph home=/home/ceph
echo "ceph ALL = (root) NOPASSWD:ALL" >> /etc/sudoers
salt '*' cmd.run 'echo "ceph ALL = (root) NOPASSWD:ALL" >> /etc/sudoers'
su - ceph
ssh-keygen -b 2048 -t rsa -f ~/.ssh/id_rsa -q -N ""
exit

salt '*' file.mkdir /home/ceph/.ssh/
salt-cp '*' /home/ceph/.ssh/id_rsa.pub /home/ceph/.ssh/authorized_keys
salt '*' file.chown /home/ceph/.ssh/authorized_keys ceph users
#salt '*' file.check_perms /home/ceph/.ssh '{}' ceph users 700
#salt '*' file.check_perms /home/ceph/.ssh/authorized_keys '{}' ceph users 700

Add Repos if necessary.
salt '*' pkg.mod_repo SESUpdates url=mirrorlist=http://$managerServer/ks/dist/child/suse-enterprise-storage-2.1-updates-x86_64/SLES12SP1
salt '*' pkg.mod_repo SESPool url=mirrorlist=http://$managerServer/ks/dist/child/suse-enterprise-storage-2.1-pool-x86_64/SLES12SP1

su - ceph
sudo zypper non-interactive in ceph-deploy
ceph-deploy install node1 node2 node3 node4 node5 mon1 mon2 mon3 ses1 ses2 ses3    <-- Auto Accept keys?
ceph-deploy new mon1 mon2 mon3
ceph-deploy mon create-initial
ceph-deploy osd prepare node{1..5:sd{b..g}  mon{1..3}:sd{b..k} ses{1..3}:sd{b..h}
ceph-deploy osd activate node{1..5}:sd{b..g}1 mon{1..3:sd{b..k}1 ses{1..3}:sd{b..h}1

Mon1:
su - ceph
sudo zypper in romana
ceph-deploy calamari --master mon1 connect node1 node2 node3 node4 node5 mon2 mon3 ses1 ses2 ses3


ceph.conf
mon_pg_warn_min_per_osd = 0   <-- Stop warning about too few PGs, we need them later.
